<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>90 Surge Admin Panel</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #121212;
      color: #f0f0f0;
      margin: 0;
      padding: 20px;
    }

    h1 {
      text-align: center;
      margin-bottom: 20px;
      font-size: 1.6em;
    }

    #admin-gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 15px;
    }

    .admin-item {
      background: #1e1e1e;
      padding: 10px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 0 6px rgba(255, 255, 255, 0.05);
    }

    .admin-item img,
    .admin-item video {
      width: 100%;
      height: auto;
      border-radius: 6px;
      max-height: 200px;
      object-fit: cover;
    }

    .admin-item p {
      font-size: 0.9em;
      margin: 8px 0;
      word-break: break-word;
    }

    .admin-item button {
      background: #e53935;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 0.9em;
      cursor: pointer;
    }

    .admin-item button:hover {
      background: #c62828;
    }

    @media (max-width: 600px) {
      h1 {
        font-size: 1.2em;
      }

      .admin-item p {
        font-size: 0.8em;
      }

      .admin-item button {
        padding: 4px 10px;
        font-size: 0.8em;
      }
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 12px;
      margin-top: 1rem;
      width: 100%;
      max-width: 800px;
    }

    .card {
      background: #1a1a1a;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(255, 255, 255, 0.05);
    }

    .card img,
    .card video {
      width: 100%;
      display: block;
      max-height: 220px;
      object-fit: cover;
    }

    .card .info {
      font-size: 0.8rem;
      padding: 0.5rem;
      text-align: center;
      color: #aaa;
    }
  </style>
</head>

<body>

  <div id="login-section">
    <h2>Admin Login</h2>
    <input type="password" id="admin-password" placeholder="Enter password" />
    <button onclick="handleLogin()">Login</button>
    <p id="login-error" style="color: red;"></p>
  </div>

  <div id="admin-content" style="display:none;">
    <button onclick="logout()" style="float:right; margin-bottom:1rem;">üö™ Logout</button>
    <button id="clearAllBtn"
      style="display:none; margin-top: 1em; background: red; color: white; padding: 0.5em 1em;">üß® Clear All</button>
    <button id="reset-social-clicks" style="margin-top: 1rem;">Reset Social Clicks (Local Test Only)</button>

    <h3 id="role-banner"></h3>

    <div style="margin-top: 2rem;">
      <label>Show Name:
        <input type="text" id="showName" placeholder="Live!" />
      </label><br /><br />
      <label>Start Time (UTC):
        <input type="datetime-local" id="startTime" />
      </label><br /><br />
      <label>End Time (UTC):
        <input type="datetime-local" id="endTime" />
      </label><br /><br />
      <div class="admin-only">
        <button onclick="saveConfig(event)">Save Config</button>
      </div>
    </div>

    <button onclick="pickWinner()" class="admin-only" style="margin-bottom: 2rem; font-weight: bold;">üéâ Pick Random
      Winner</button>
    <div id="winnerDisplay" style="font-size: 1.2em; margin-top: 1rem;"></div>
    <div id="entries-by-user" style="margin: 2rem 0; color: #f0f0f0;"></div>

    <div id="admin-gallery">Loading uploads...</div>
  </div>

  <script>
    function renderEntriesPerUser(uploads) {
      const entryMap = {};

      uploads.forEach(upload => {
        const name = upload.userName || upload.userNameRaw || "Unknown";
        if (!entryMap[name]) entryMap[name] = 0;

        const baseEntry = 1;
        const extraVotes = Math.max(parseInt(upload.votes || 0), 0);
        entryMap[name] += baseEntry + extraVotes;
      });

      const container = document.getElementById("entries-by-user");
      container.innerHTML = `<h3>üéüÔ∏è Raffle Entries by User</h3>`;
      const list = document.createElement("ul");
      list.style.listStyle = "none";
      list.style.padding = "0";

      Object.entries(entryMap)
        .sort((a, b) => b[1] - a[1])
        .forEach(([name, totalEntries]) => {
          const li = document.createElement("li");
          li.textContent = `${name}: ${totalEntries} entries`;
          list.appendChild(li);
        });

      container.appendChild(list);
    }
  </script>

  <script>
    async function resetVotes() {
      if (!confirm("Reset all votes and re-enable voting?")) return;

      console.log("üîê Role being sent:", localStorage.getItem('role'));

      const res = await fetch('/api/admin?action=reset-votes', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ role: localStorage.getItem('role') })
      });

      const data = await res.json();
      if (res.ok && data.success) {
        Object.keys(localStorage).forEach(key => {
          if (key.startsWith("voted_")) localStorage.removeItem(key);
        });

        alert('‚úÖ Votes reset! Voting re-enabled.');
        throttledLoadAdminGallery();
      } else {
        alert('‚ùå Failed to reset votes: ' + (data.error || res.status));
      }
    }

  </script>
  <script>

    let role = null;

    // ‚úÖ Inject Reset Votes button for admins only
    const resetBtn = document.createElement("button");
    resetBtn.textContent = "Reset All Votes";
    resetBtn.style.background = "orange";
    resetBtn.style.color = "white";
    resetBtn.style.padding = "0.5rem 1rem";
    resetBtn.style.borderRadius = "6px";
    resetBtn.style.marginTop = "0.5rem";
    resetBtn.onclick = resetVotes;

    const clearBtn = document.getElementById("clearAllBtn");
    clearBtn.insertAdjacentElement("afterend", resetBtn);


    async function handleLogin() {
      const password = document.getElementById('admin-password').value;
      const res = await fetch('/api/admin?action=login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password })
      });
      const data = await res.json();
      if (data.success) {
        localStorage.setItem('role', data.role);
        localStorage.setItem('authToken', password);
        if (data.role === 'admin') {
          localStorage.setItem('adminKey', password); // ‚úÖ only for full admin
        }
        location.reload();
      } else {
        document.getElementById('login-error').textContent = '‚ùå Incorrect password';
      }
    }


    function logout() {
      localStorage.clear(); // more reliable than removing one key
      window.location.href = "/admin?ts=" + Date.now(); // bypass cache
    }


    async function loadConfig(currentRole) {
      if (currentRole !== 'admin') return;

      const cached = sessionStorage.getItem("cachedConfig");
      if (cached) {
        try {
          const parsed = JSON.parse(cached);
          if (parsed.timestamp > Date.now() - 5 * 60 * 1000) {
            applyConfig(parsed.data); // Custom function to set fields
            return;
          }
        } catch { }
      }

      try {
        const res = await fetch('/api/admin?action=config');
        const config = await res.json();
        sessionStorage.setItem("cachedConfig", JSON.stringify({
          timestamp: Date.now(),
          data: config
        }));
        applyConfig(config);
      } catch (err) {
        alert('‚ùå Failed to load config');
        console.error(err);
      }
    }
    function applyConfig(config) {
      document.getElementById('showName').value = config.showName || '';
      if (config.startTime) {
        document.getElementById('startTime').value = config.startTime.slice(0, 16);
      }
      if (config.endTime) {
        document.getElementById('endTime').value = config.endTime.slice(0, 16);
      }
    }

    async function loadConfigWithRetry(attempts = 3) {
      for (let i = 0; i < attempts; i++) {
        try {
          await loadConfig('admin');
          return;
        } catch (err) {
          console.warn(`‚ö†Ô∏è Attempt ${i + 1} to load config failed:`, err.message);
          if (i < attempts - 1) await new Promise(res => setTimeout(res, 1000));
        }
      }
      alert('‚ùå Unable to load config after multiple attempts');
    }

    async function saveConfig(event) {
      if (role !== 'admin') return;
      event.preventDefault();
      const showName = document.getElementById('showName')?.value?.trim();
      const startTimeRaw = document.getElementById('startTime')?.value;
      const endTimeRaw = document.getElementById('endTime')?.value;
      if (!showName || !startTimeRaw || !endTimeRaw) {
        alert('‚ùå Please fill in all fields');
        return;
      }
      const body = {
        showName,
        startTime: new Date(startTimeRaw).toISOString(),
        endTime: new Date(endTimeRaw).toISOString()
      };
      try {
        const res = await fetch('/api/admin?action=config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const json = await res.json();
        if (res.ok) alert('‚úÖ Config saved!');
        else alert('‚ùå Save failed: ' + (json.error || 'Unknown error'));
      } catch (err) {
        alert('‚ùå Save failed (network error)');
        console.error(err);
      }
    }
    let lastGalleryLoadTime = 0;

    function throttledLoadAdminGallery() {
      const now = Date.now();
      if (now - lastGalleryLoadTime > 1000) {
        lastGalleryLoadTime = now;
        loadAdminGallery();
      } else {
        console.log("üõë Skipped gallery reload ‚Äì throttled");
      }
    }
    async function loadAdminGallery() {
      try {
        const uploadsRes = await fetch('/api/admin?action=uploads');
        const uploads = await uploadsRes.json();

        const listRes = await fetch('/api/admin?action=list-r2-files');
        const fileList = await listRes.json();

        const validFiles = new Set(fileList.files.map(f => f.key));

        const galleryData = uploads
          .filter(u => validFiles.has(u.fileName))
          .sort((a, b) => new Date(b.createdTime).valueOf() - new Date(a.createdTime).valueOf());

        renderEntriesPerUser(galleryData);

        const gallery = document.getElementById("admin-gallery");
        gallery.innerHTML = "";

        galleryData.forEach(file => {
          const card = document.createElement("div");
          card.className = "card";

          const wrapper = document.createElement("div");
          wrapper.style.position = "relative";

          let media;
          if (file.type === "video") {
            media = document.createElement("video");
            media.src = file.fileUrl;
            media.controls = true;
            media.muted = true;
            media.style.width = "100%";
            media.style.maxHeight = "220px";
            media.style.objectFit = "cover";
          } else {
            media = document.createElement("img");
            media.src = file.fileUrl;
            media.loading = "lazy";
            media.style.cursor = "pointer";
            media.style.maxHeight = "220px";
            media.style.width = "100%";
            media.style.objectFit = "cover";
            media.style.filter = "blur(8px)";
            media.style.transition = "filter 0.5s";
            media.addEventListener("load", () => {
              media.style.filter = "none";
            });
          }

          wrapper.appendChild(media);
          card.appendChild(wrapper);

          const info = document.createElement("div");
          info.className = "info";
          const displayName =
            file.userName || file.userNameRaw || file.fileName.split("_").slice(2).join("_").replace(/_/g, " ") || "Anonymous";
          info.textContent = `Uploaded by @${displayName}`;
          card.appendChild(info);

          const deleteBtn = document.createElement("button");
          deleteBtn.textContent = "üóë Delete";
          deleteBtn.onclick = () => deleteFile(file.fileName, displayName);
          card.appendChild(deleteBtn);

          gallery.appendChild(card);
        });

      } catch (err) {
        console.error("‚ùå Failed to load admin gallery:", err);
        document.getElementById("admin-gallery").innerHTML = "<p style='color:red'>Failed to load gallery</p>";
      }
    }

    async function deleteFile(fileId, name) {
      if (!fileId) return alert('Invalid file ID');
      const confirmDelete = confirm(`Are you sure you want to delete:\n\n${name}?`);
      if (!confirmDelete) return;
      const res = await fetch('/api/admin?action=delete-file', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ fileId })
      });
      const result = await res.json();
      if (res.ok) {
        alert('‚úÖ File deleted');
        throttledLoadAdminGallery();
        localStorage.setItem('galleryRefresh', Date.now());
      }
      else {
        alert('‚ùå ' + (result.error || 'Failed to delete file.'));
      }
    }

    document.getElementById('clearAllBtn')?.addEventListener('click', async () => {
      if (!confirm("This will remove all files from R2 and Redis")) return;

      console.log("üîê Sending auth:", localStorage.getItem('adminKey'));

      try {
        const res = await fetch('/api/admin?action=clear-all', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer:super:' + localStorage.getItem('adminKey'),
          },
          body: JSON.stringify({})
        });

        const text = await res.text();
        let result;

        try {
          result = JSON.parse(text);
        } catch (e) {
          console.error("‚ùå Invalid JSON from server:", text);
          throw new Error("Server error: " + text);
        }

        if (!res.ok || !result.success) {
          throw new Error(result?.error || "Unknown server error");
        }

        alert('‚úÖ All uploads cleared!');
        location.reload();

      } catch (err) {
        console.error("‚ùå Failed to clear all:", err);
        alert('‚ùå Failed to clear all: ' + err.message);
      }
    });


  </script>
  <script>
    async function pickWinner() {
      if (!confirm("Pick a random winner from all uploads?")) return;
      try {
        const res = await fetch('/api/admin?action=pick-winner', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer:super:' + localStorage.getItem('adminKey'),
          },
          body: JSON.stringify({ role: 'admin' })  // ‚úÖ required!
        });

        const result = await res.json();

        if (result && result.winner && result.winner.name) {
          const winnerName = result.winner.name;

          // üîÅ Fire SSE broadcast
          await fetch(
            location.hostname === "localhost"
              ? "http://localhost:3001/broadcast"
              : "https://winner-sse-server.onrender.com/announce-winner",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ winner: winnerName }),
            }
          );

          localStorage.setItem("shownWinnerName", result.winner.name);
          document.getElementById('winnerDisplay').textContent = `üéâ Winner: ${winnerName}`;
        }
      } catch (err) {
        console.error("‚ùå Error picking winner:", err);
        alert("‚ùå Failed to pick winner");
      }
    }
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      role = localStorage.getItem('role');
      if (!role) return;

      document.getElementById('login-section').style.display = 'none';
      document.getElementById('admin-content').style.display = 'block';

      loadConfigWithRetry(); // ‚úÖ safer than single attempt
      loadAdminGallery();

      if (role === 'moderator') {
        document.querySelector('div[style*="margin-top: 2rem"]').style.display = 'none';
        document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
        document.getElementById('role-banner').textContent = 'üëÆ Moderator View ‚Äì Delete Only';
      } else {
        document.getElementById('clearAllBtn').style.display = 'inline-block';
        document.getElementById('role-banner').textContent = 'üëë Admin View ‚Äì Full Access';

        const resetBtn = document.createElement("button");
        resetBtn.textContent = "Reset All Votes";
        resetBtn.style.background = "orange";
        resetBtn.style.color = "white";
        resetBtn.style.padding = "0.5rem 1rem";
        resetBtn.style.borderRadius = "6px";
        resetBtn.style.marginTop = "0.5rem";
        resetBtn.onclick = resetVotes;

        const clearBtn = document.getElementById("clearAllBtn");
        clearBtn.insertAdjacentElement("afterend", resetBtn);
      }
    });
  </script>



</body>

</html>