<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>90 Surge Admin Panel</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #121212;
      color: #f0f0f0;
      margin: 0;
      padding: 20px;
    }

    h1 {
      text-align: center;
      margin-bottom: 20px;
      font-size: 1.6em;
    }

    #admin-gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 15px;
    }

    .admin-item {
      background: #1e1e1e;
      padding: 10px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 0 6px rgba(255, 255, 255, 0.05);
    }

    .admin-item img,
    .admin-item video {
      width: 100%;
      height: auto;
      border-radius: 6px;
      max-height: 200px;
      object-fit: cover;
    }

    .admin-item p {
      font-size: 0.9em;
      margin: 8px 0;
      word-break: break-word;
    }

    .admin-item button {
      background: #e53935;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 0.9em;
      cursor: pointer;
    }

    .admin-item button:hover {
      background: #c62828;
    }

    @media (max-width: 600px) {
      h1 {
        font-size: 1.2em;
      }

      .admin-item p {
        font-size: 0.8em;
      }

      .admin-item button {
        padding: 4px 10px;
        font-size: 0.8em;
      }
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 12px;
      margin-top: 1rem;
      width: 100%;
      max-width: 800px;
    }

    .card {
      background: #1a1a1a;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(255, 255, 255, 0.05);
    }

    .card img,
    .card video {
      width: 100%;
      display: block;
      max-height: 220px;
      object-fit: cover;
    }

    .card .info {
      font-size: 0.8rem;
      padding: 0.5rem;
      text-align: center;
      color: #aaa;
    }
  </style>
</head>

<body>

  <div id="login-section">
    <h2>Admin Login</h2>
    <input type="password" id="admin-password" placeholder="Enter password" />
    <button onclick="handleLogin()">Login</button>
    <p id="login-error" style="color: red;"></p>
  </div>

  <div id="admin-content" style="display:none;">
    <button onclick="logout()" style="float:right; margin-bottom:1rem;">üö™ Logout</button>
    <button id="clearAllBtn"
      style="display:none; margin-top: 1em; background: red; color: white; padding: 0.5em 1em;">üß® Clear All</button>
    <button id="reset-social-clicks" style="margin-top: 1rem;">Reset Social Clicks (Local Test Only)</button>

    <h1>üéõÔ∏è Admin Panel ‚Äì Manage Uploads</h1>
    <h3 id="role-banner"></h3>

    <div style="margin-top: 2rem;">
      <label>Show Name:
        <input type="text" id="showName" placeholder="90 Surge at Echo Club" />
      </label><br /><br />
      <label>Start Time (UTC):
        <input type="datetime-local" id="startTime" />
      </label><br /><br />
      <label>End Time (UTC):
        <input type="datetime-local" id="endTime" />
      </label><br /><br />
      <div class="admin-only">
        <button onclick="saveConfig(event)">Save Config</button>
      </div>
    </div>

    <button onclick="pickWinner()" class="admin-only" style="margin-bottom: 2rem; font-weight: bold;">üéâ Pick Random
      Winner</button>
    <div id="winnerDisplay" style="font-size: 1.2em; margin-top: 1rem;"></div>

    <div id="admin-gallery">Loading uploads...</div>
  </div>

  <script>
    let role = null;

    document.addEventListener('DOMContentLoaded', () => {
      role = localStorage.getItem('role');
      if (!role) return;

      document.getElementById('login-section').style.display = 'none';
      document.getElementById('admin-content').style.display = 'block';

      loadConfig(role);
      loadAdminGallery();

      if (role === 'moderator') {
        document.querySelector('div[style*="margin-top: 2rem"]').style.display = 'none';
        document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
        document.getElementById('role-banner').textContent = 'üëÆ Moderator View ‚Äì Delete Only';
      } else {
        document.getElementById('clearAllBtn').style.display = 'inline-block';
        document.getElementById('role-banner').textContent = 'üëë Admin View ‚Äì Full Access';

        // ‚úÖ Inject Reset Votes button for admins only
        const resetBtn = document.createElement("button");
        resetBtn.textContent = "Reset All Votes";
        resetBtn.style.background = "orange";
        resetBtn.style.color = "white";
        resetBtn.style.padding = "0.5rem 1rem";
        resetBtn.style.borderRadius = "6px";
        resetBtn.style.marginTop = "0.5rem";
        resetBtn.onclick = resetVotes;

        const clearBtn = document.getElementById("clearAllBtn");
        clearBtn.insertAdjacentElement("afterend", resetBtn);

      }
    });

    async function handleLogin() {
      const password = document.getElementById('admin-password').value;
      const res = await fetch('/api/admin?action=login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password })
      });
      const data = await res.json();
      if (data.success) {
        localStorage.setItem('role', data.role);
        if (data.role === 'admin') {
          localStorage.setItem('adminKey', password); // ‚úÖ only for full admin
        }
        location.reload();
      } else {
        document.getElementById('login-error').textContent = '‚ùå Incorrect password';
      }
    }


    function logout() {
      localStorage.clear(); // more reliable than removing one key
      window.location.href = "/admin?ts=" + Date.now(); // bypass cache
    }


    async function loadConfig(currentRole) {
      if (currentRole !== 'admin') return;
      try {
        const res = await fetch('/api/admin?action=config');
        const config = await res.json();
        document.getElementById('showName').value = config.showName || '';
        if (config.startTime) document.getElementById('startTime').value = config.startTime.slice(0, 16);
        if (config.endTime) document.getElementById('endTime').value = config.endTime.slice(0, 16);
      } catch (err) {
        alert('‚ùå Failed to load config');
        console.error(err);
      }
    }

    async function saveConfig(event) {
      if (role !== 'admin') return;
      event.preventDefault();
      const showName = document.getElementById('showName')?.value?.trim();
      const startTimeRaw = document.getElementById('startTime')?.value;
      const endTimeRaw = document.getElementById('endTime')?.value;
      if (!showName || !startTimeRaw || !endTimeRaw) {
        alert('‚ùå Please fill in all fields');
        return;
      }
      const body = {
        showName,
        startTime: new Date(startTimeRaw).toISOString(),
        endTime: new Date(endTimeRaw).toISOString()
      };
      try {
        const res = await fetch('/api/admin?action=config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const json = await res.json();
        if (res.ok) alert('‚úÖ Config saved!');
        else alert('‚ùå Save failed: ' + (json.error || 'Unknown error'));
      } catch (err) {
        alert('‚ùå Save failed (network error)');
        console.error(err);
      }
    }

    async function checkWinner() {
  try {
    const res = await fetch("/api/admin?action=winner");
    if (!res.ok) return;

    const data = await res.json();
    if (data.winner && data.winner.name) {
      const currentWinner = data.winner.name;

      const shownWinner = localStorage.getItem("shownWinnerName");
      if (shownWinner !== currentWinner) {
        localStorage.setItem("shownWinnerName", currentWinner);
        showWinnerModal(currentWinner);
      }
    }
  } catch (err) {
    console.warn("Failed to fetch winner:", err);
  }
}



    async function loadAdminGallery() {
      try {
        const uploadsRes = await fetch("/api/uploads");
        const uploads = await uploadsRes.json();

        if (!Array.isArray(uploads)) throw new Error("Response was not an array");

        const gallery = document.getElementById("admin-gallery");
        gallery.innerHTML = '';

        uploads.forEach(file => {
          const card = document.createElement("div");
          card.className = "card";

          let media;
          if (file.type === "video") {
            media = document.createElement("video");
            media.src = file.fileUrl;
            media.controls = true;
            media.muted = true;
          } else {
            media = document.createElement("img");
            media.src = file.fileUrl;
            media.style.cursor = "pointer";
          }

          const info = document.createElement("div");
          info.className = "info";
          info.textContent = file.userName || "Anonymous";

          const deleteBtn = document.createElement("button");
          deleteBtn.textContent = "üóë Delete";
          deleteBtn.onclick = () => deleteFile(file.fileName, file.userName);

          card.appendChild(media);
          card.appendChild(info);
          card.appendChild(deleteBtn);
          gallery.appendChild(card);
        });

      } catch (err) {
        console.error("‚ùå Failed to load admin gallery:", err);
        document.getElementById("admin-gallery").innerHTML = "<p style='color:red'>Failed to load gallery</p>";
      }
    }


    async function deleteFile(fileId, name) {
      if (!fileId) return alert('Invalid file ID');
      const confirmDelete = confirm(`Are you sure you want to delete:\n\n${name}?`);
      if (!confirmDelete) return;
      const res = await fetch('/api/admin?action=delete-file', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ fileId })
      });
      const result = await res.json();
      if (res.ok) {
        alert('‚úÖ File deleted');
        loadAdminGallery();
        localStorage.setItem('galleryRefresh', Date.now());
      } else {
        alert('‚ùå ' + (result.error || 'Failed to delete file.'));
      }
    }

    document.getElementById('clearAllBtn')?.addEventListener('click', async () => {
      if (!confirm("Are you sure you want to delete ALL uploads and Drive files?")) return;

      console.log("üîê Sending auth:", localStorage.getItem('adminKey'));

      try {
        const res = await fetch('/api/admin?action=clear-all', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer:super:' + localStorage.getItem('adminKey'),
          },
          body: JSON.stringify({}) // ‚Üê this is the missing piece!
        });


        const text = await res.text();
        let result;

        try {
          result = JSON.parse(text);
        } catch (e) {
          console.error("‚ùå Invalid JSON from server:", text);
          throw new Error("Server error: " + text);
        }

        if (!res.ok || !result.success) {
          throw new Error(result?.error || "Unknown server error");
        }

        alert('‚úÖ All uploads and Drive files cleared!');
        location.reload();

      } catch (err) {
        console.error("‚ùå Failed to clear all:", err);
        alert('‚ùå Failed to clear all: ' + err.message);
      }
    });


  </script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const role = localStorage.getItem("role");
      if (role === 'admin' && !localStorage.getItem('adminKey')) {
        const keyFromPrompt = prompt("Re-enter admin password to enable full access:");
        if (keyFromPrompt) localStorage.setItem('adminKey', keyFromPrompt);
      }

      // Show button only for super admins
      if (role !== "admin") {
        const btn = document.getElementById("reset-social-clicks");
        if (btn) btn.style.display = "none";
      }

      // Handle click
      const resetSocialBtn = document.getElementById("reset-social-clicks");
      if (resetSocialBtn) {
        resetSocialBtn.addEventListener("click", () => {
          localStorage.removeItem("followed");
          localStorage.removeItem("followedTime");
          localStorage.removeItem("softRefreshDone");
          alert("‚úÖ Social click flags have been reset in localStorage.");
        });
      }
    });
  </script>

  <script>
    async function resetVotes() {
      if (!confirm("Are you sure you want to reset ALL votes?")) return;

      const res = await fetch('/api/admin?action=reset-votes', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ role: localStorage.getItem('role') })
      });

      const data = await res.json();
      if (res.ok && data.success) {
        alert('‚úÖ Votes reset!');
      } else {
        alert('‚ùå Failed to reset votes: ' + (data.error || res.status));
      }
    }

  </script>

</body>

</html>